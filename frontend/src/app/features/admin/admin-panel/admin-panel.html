<div class="admin-panel">
  <div class="admin-header">
    <h1>Admin Panel</h1>
    <button class="btn-back" (click)="goToChat()">Back to Chat</button>
  </div>

  <!-- Messages -->
  @if (errorMessage) {
    <div class="alert alert-error">{{ errorMessage }}</div>
  }
  @if (successMessage) {
    <div class="alert alert-success">{{ successMessage }}</div>
  }

  <!-- Tabs -->
  <div class="tabs">
    <button 
      class="tab" 
      [class.active]="activeTab === 'categories'"
      (click)="setActiveTab('categories')">
      Categories ({{ categories.length }})
    </button>
    <button 
      class="tab" 
      [class.active]="activeTab === 'rooms'"
      (click)="setActiveTab('rooms')">
      Rooms ({{ rooms.length }})
    </button>
    <button 
      class="tab" 
      [class.active]="activeTab === 'users'"
      (click)="setActiveTab('users')">
      Users ({{ users.length }})
    </button>
  </div>

  <!-- Categories Tab -->
  @if (activeTab === 'categories') {
    <div class="tab-content">
      <div class="form-section">
        <h2>{{ editingCategory ? 'Edit Category' : 'Create Category' }}</h2>
        <form [formGroup]="categoryForm" (ngSubmit)="editingCategory ? updateCategory() : createCategory()">
          <div class="form-group">
            <label>Name</label>
            <input type="text" formControlName="name" placeholder="Category name" />
            @if (categoryForm.get('name')?.invalid && categoryForm.get('name')?.touched) {
              <span class="error">Name is required (min 2 characters)</span>
            }
          </div>

          <div class="form-group">
            <label>Description</label>
            <textarea formControlName="description" placeholder="Category description"></textarea>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-primary" [disabled]="!categoryForm.valid || isLoading">
              {{ editingCategory ? 'Update' : 'Create' }} Category
            </button>
            @if (editingCategory) {
              <button type="button" class="btn-secondary" (click)="cancelEditCategory()">Cancel</button>
            }
          </div>
        </form>
      </div>

      <div class="list-section">
        <h2>Categories ({{ categories.length }})</h2>
        @if (isLoading) {
          <p>Loading...</p>
        } @else {
          <table class="data-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Description</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              @for (category of categories; track category.id) {
                <tr>
                  <td>{{ category.id }}</td>
                  <td>{{ category.name }}</td>
                  <td>{{ category.description || '-' }}</td>
                  <td>
                    <button class="btn-small" (click)="editCategory(category)">Edit</button>
                    <button class="btn-small btn-danger" (click)="deleteCategory(category.id)">Delete</button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        }
      </div>
    </div>
  }

  <!-- Rooms Tab -->
  @if (activeTab === 'rooms') {
    <div class="tab-content">
      <div class="form-section">
        <h2>{{ editingRoom ? 'Edit Room' : 'Create Room' }}</h2>
        <form [formGroup]="roomForm" (ngSubmit)="editingRoom ? updateRoom() : createRoom()">
          <div class="form-group">
            <label>Name</label>
            <input type="text" formControlName="name" placeholder="Room name" />
            @if (roomForm.get('name')?.invalid && roomForm.get('name')?.touched) {
              <span class="error">Name is required (min 2 characters)</span>
            }
          </div>

          <div class="form-group">
            <label>Description</label>
            <textarea formControlName="description" placeholder="Room description"></textarea>
          </div>

          <div class="form-group">
            <label>Category</label>
            <select formControlName="category_id">
              <option value="">Select category</option>
              @for (category of categories; track category.id) {
                <option [value]="category.id">{{ category.name }}</option>
              }
            </select>
            @if (roomForm.get('category_id')?.invalid && roomForm.get('category_id')?.touched) {
              <span class="error">Category is required</span>
            }
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" formControlName="is_private" />
              Private Room
            </label>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-primary" [disabled]="!roomForm.valid || isLoading">
              {{ editingRoom ? 'Update' : 'Create' }} Room
            </button>
            @if (editingRoom) {
              <button type="button" class="btn-secondary" (click)="cancelEditRoom()">Cancel</button>
            }
          </div>
        </form>
      </div>

      <div class="list-section">
        <h2>Rooms ({{ rooms.length }})</h2>
        @if (isLoading) {
          <p>Loading...</p>
        } @else {
          <table class="data-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Category</th>
                <th>Private</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              @for (room of rooms; track room.id) {
                <tr>
                  <td>{{ room.id }}</td>
                  <td>{{ room.name }}</td>
                  <td>{{ room.category_name }}</td>
                  <td>{{ room.is_private ? 'Yes' : 'No' }}</td>
                  <td>
                    <button class="btn-small" (click)="editRoom(room)">Edit</button>
                    <button class="btn-small btn-danger" (click)="deleteRoom(room.id)">Delete</button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        }
      </div>
    </div>
  }

  <!-- Users Tab -->
  @if (activeTab === 'users') {
    <div class="tab-content">
      @if (editingUser) {
        <div class="form-section">
          <h2>Edit User</h2>
          <form [formGroup]="userForm" (ngSubmit)="updateUser()">
            <div class="form-group">
              <label>Name</label>
              <input type="text" formControlName="name" placeholder="User name" />
            </div>

            <div class="form-group">
              <label>Email</label>
              <input type="email" formControlName="email" placeholder="user@example.com" />
            </div>

            <div class="form-group">
              <label>Password (leave empty to keep current)</label>
              <input type="password" formControlName="password" placeholder="New password" />
            </div>

            @if (!isCurrentUser(editingUser.id)) {
              <div class="form-group">
                <label>
                  <input type="checkbox" formControlName="is_admin" />
                  Admin User
                </label>
              </div>
            }

            <div class="form-actions">
              <button type="submit" class="btn-primary" [disabled]="!userForm.valid || isLoading">
                Update User
              </button>
              <button type="button" class="btn-secondary" (click)="cancelEditUser()">Cancel</button>
            </div>
          </form>
        </div>
      }

      <div class="list-section">
        <h2>Users ({{ users.length }})</h2>
        @if (isLoading) {
          <p>Loading...</p>
        } @else {
          <table class="data-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Admin</th>
                <th>Private Rooms</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              @for (user of users; track user.id) {
                <tr>
                  <td>{{ user.id }}</td>
                  <td>
                    {{ user.name }}
                    @if (isCurrentUser(user.id)) {
                      <span class="badge-current">(You)</span>
                    }
                  </td>
                  <td>{{ user.email }}</td>
                  <td>
                    @if (user.is_admin) {
                      <span class="badge-admin">Admin</span>
                    } @else {
                      <span class="badge-user">User</span>
                    }
                  </td>
                  <td>{{ user.rooms_count || 0 }}</td>
                  <td>
                    <button 
                      class="btn-small" 
                      (click)="editUser(user)">
                      Edit
                    </button>
                    <button 
                      class="btn-small" 
                      (click)="selectUserForRooms(user)">
                      Manage Rooms
                    </button>
                    <button 
                      class="btn-small btn-danger" 
                      (click)="deleteUser(user.id)">
                      Delete
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        }
      </div>

      <!-- Room Management Modal -->
      @if (selectedUserForRooms) {
        <div class="modal-overlay" (click)="closeUserRooms()">
          <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
              <h2>Manage Private Rooms for {{ selectedUserForRooms.name }}</h2>
              <button class="btn-close" (click)="closeUserRooms()">Ã—</button>
            </div>

            <div class="modal-body">
              <!-- Assign Room Form -->
              <div class="form-section">
                <h3>Assign New Private Room</h3>
                <form [formGroup]="assignRoomForm" (ngSubmit)="assignRoomToUserSubmit()">
                  <div class="form-group">
                    <label>Select Private Room</label>
                    <select formControlName="room_id">
                      <option value="">Choose a room...</option>
                      @for (room of availableRoomsForUser; track room.id) {
                        <option [value]="room.id">{{ room.name }} ({{ room.category_name }})</option>
                      }
                    </select>
                  </div>
                  <button type="submit" class="btn-primary" [disabled]="!assignRoomForm.valid || isLoading">
                    Assign Room
                  </button>
                </form>
              </div>

              <!-- Current Rooms -->
              <div class="user-rooms-section">
                <h3>Current Private Rooms ({{ userRooms.length }})</h3>
                @if (userRooms.length === 0) {
                  <p class="empty-message">No private rooms assigned yet. (Public rooms are accessible to all users)</p>
                } @else {
                  <table class="data-table">
                    <thead>
                      <tr>
                        <th>Room Name</th>
                        <th>Category</th>
                        <th>Private</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (room of userRooms; track room.id) {
                        <tr>
                          <td>{{ room.name }}</td>
                          <td>{{ room.category?.name || 'N/A' }}</td>
                          <td>{{ room.is_private ? 'Yes' : 'No' }}</td>
                          <td>
                            <button class="btn-small btn-danger" (click)="removeUserRoom(room.id)">
                              Remove
                            </button>
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                }
              </div>
            </div>
          </div>
        </div>
      }
    </div>
  }
</div>
